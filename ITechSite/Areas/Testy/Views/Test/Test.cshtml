@model dynamic

@{
    Layout = "~/Areas/Testy/Views/Shared/_TestyNoLayout.cshtml";
    ViewBag.Title = "Wybierz właściwą odpowiedź";
}

<div class="content test-start">
    @if(@Model.question == null)
    {
        @Html.ActionLink("Rozpocznij", "Test", new { @questionId = Model.test.getFirstQuestionId(), @accessionNumber = Model.test.accessionNumber }, new { @class = "btn btn-start-test" })
    }
    else
    {
    <div class="test">
        @ViewBag.Title

         <div class="question">
            <p>
                @Model.question.content
            </p>
        </div>
    
        <div class="answers">
            @foreach (var ans in @Model.question.Odpowiedzi)
            {
                <div class="answer">
                    <input type="radio" name="answer[]" value="@ans.id" class="test-radio" />
                    <p>
                        @ans.content
                    </p>
                </div>
            }
        </div>
    </div>    
        if(Model.test.getPreviousQuestionId(Model.question.id) != 0)
        {
            <a href="@Url.Action("Test", "Test", new{ @questionId = Model.test.getPreviousQuestionId(Model.question.id), @accessionNumber = Model.test.accessionNumber })" id="prev"><i class="fa fa-chevron-left"></i></a>    
        }
        if(Model.test.getNextQuestionId(Model.question.id) != 0)
        {
            <a href="@Url.Action("Test", "Test", new{ @questionId = Model.test.getNextQuestionId(Model.question.id), @accessionNumber = Model.test.accessionNumber })" id="next"><i class="fa fa-chevron-right"></i></a>
        }
        else
        {
            <a href="@Url.Action("EndTest", "Test", new{ @accessionNumber = Model.test.accessionNumber })" id="end_test"><i class="fa fa-power-off"></i></a>
        }
    }
</div>
<script type="text/javascript">
    $(document).ready(function () {
        @if(@Model.question != null)
        {
            <text>
                $.ajax({
                    type: "POST",
                    url: '/Test/LogTest?questionId=@Model.question.id&testId=@Model.test.id'
                });
                $(window).unload(function () {
                    var data = { "answers[]": [] };
                    $(":checked").each(function () {
                        data["answers[]"].push($(this).val());
                    });
                    $.ajax({
                        type: 'post',
                        async: false,
                        url: '/Test/LogTest?questionId=@Model.question.id&testId=@Model.test.id',
                        data: data
                    });
                });
            </text>
        }

        @if(@ViewBag.userAnswer != null)
        {
            <text>
                $('input[value="@ViewBag.userAnswer"]').attr('checked', 'checked');
                $('input[value="@ViewBag.userAnswer"]').parent().css('background-color', '#C8E6C9');
            </text>
        }

        $('.test-radio').change(function () {
            if ($(this).attr('checked')) {
                $('.answer').css('background-color', 'rgba(0, 0, 0, 0.1)');
                $(this).parent().css('background-color', '#C8E6C9');
            }
        });

        $('.answer').click(function () {
            $(this).find('.test-radio').trigger('change');
            console.log('click');
        });
    });
</script>